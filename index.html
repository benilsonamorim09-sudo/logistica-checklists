<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Log√≠stica</title>
    
    <!-- Configura√ß√£o para parecer App (PWA) -->
    <meta name="theme-color" content="#1e40af">
    <link rel="manifest" href="manifest.json">
    
    <!-- Estilos e Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Cabe√ßalho -->
        <div class="bg-blue-800 p-6 text-center">
            <h1 class="text-white text-2xl font-bold uppercase tracking-wide">üöõ Vistoria de Sa√≠da</h1>
            <p class="text-blue-200 text-xs mt-1">Sistema Integrado Log√≠stico</p>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- Campo Placa -->
            <div>
                <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">Placa do Ve√≠culo</label>
                <input type="text" id="placa" class="w-full p-4 border-2 border-gray-200 rounded-xl text-xl font-bold text-center uppercase tracking-widest focus:border-blue-500 outline-none transition" placeholder="ABC-1234">
            </div>

            <!-- Campo Motorista -->
            <div>
                <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">Nome do Motorista</label>
                <input type="text" id="motorista" class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg focus:border-blue-500 outline-none transition" placeholder="Nome Completo">
            </div>

            <!-- Campo Pneus -->
            <div>
                <label class="block text-gray-700 font-bold mb-2 text-sm uppercase">Situa√ß√£o dos Pneus</label>
                <div class="relative">
                    <select id="pneu_ok" class="w-full p-4 border-2 border-gray-200 rounded-xl text-lg bg-white appearance-none focus:border-blue-500 outline-none transition">
                        <option value="true">‚úÖ APROVADO - Em bom estado</option>
                        <option value="false">‚ùå REPROVADO - Pneu careca/furo</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">‚ñº</div>
                </div>
            </div>

            <!-- Campo Foto (C√¢mera) -->
            <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100 border-dashed">
                <label class="block text-blue-800 font-bold mb-2 text-sm uppercase text-center">üì∏ Evid√™ncia Obrigat√≥ria</label>
                <input type="file" id="foto" accept="image/*" capture="environment" class="w-full text-sm text-slate-500
                  file:mr-4 file:py-3 file:px-4
                  file:rounded-full file:border-0
                  file:text-sm file:font-bold
                  file:bg-blue-600 file:text-white
                  file:cursor-pointer hover:file:bg-blue-700
                ">
                <p class="text-xs text-center text-blue-400 mt-2">Tire uma foto clara da carga ou ve√≠culo</p>
            </div>

            <!-- Bot√£o de A√ß√£o -->
            <button onclick="enviarDados()" id="btnEnviar" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-5 rounded-xl text-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                <span>üìç ENVIAR REGISTRO</span>
            </button>
            
            <!-- Status -->
            <p id="status" class="text-center text-xs font-bold text-gray-400 mt-2">Sistema Online ‚Ä¢ Pronto para envio</p>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO SUPABASE ---
        const PROJECT_URL = 'https://jbpuhbrjkpjhfqxiqluf.supabase.co';
        const PROJECT_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpicHVoYnJqa3BqaGZxeGlxbHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTU3MjgsImV4cCI6MjA4MTQ5MTcyOH0.fT7sv6y89AqymzSyFFm-Ct48A-_gcUNXMb42ZiR6SRk';

        // Cria conex√£o usando nome √∫nico para evitar erros
        const meuSupabase = window.supabase.createClient(PROJECT_URL, PROJECT_KEY);

        async function enviarDados() {
            const btn = document.getElementById('btnEnviar');
            const status = document.getElementById('status');
            
            // 1. Bloqueia bot√£o
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = '<span>‚è≥ PROCESSANDO...</span>';
            status.innerText = "üîÑ Iniciando GPS de alta precis√£o...";

            // 2. Configura√ß√£o GPS
            const opcoesGPS = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };

            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    status.innerText = "üìç Localiza√ß√£o obtida! Enviando imagem...";
                    
                    // 3. Valida√ß√£o dos Campos
                    const placa = document.getElementById('placa').value.toUpperCase();
                    const motorista = document.getElementById('motorista').value;
                    const pneuOk = document.getElementById('pneu_ok').value === 'true';
                    const arquivoFoto = document.getElementById('foto').files[0];

                    if (!placa || !motorista) throw new Error("Preencha Placa e Motorista!");
                    if (!arquivoFoto) throw new Error("A foto √© obrigat√≥ria para auditoria!");

                    // 4. Upload da Foto
                    const nomeArquivo = Date.now() + '_' + Math.random().toString(36).substring(7) + '.jpg';
                    const { error: erroUpload } = await meuSupabase.storage
                        .from('evidencias')
                        .upload(nomeArquivo, arquivoFoto);

                    if (erroUpload) throw erroUpload;

                    // URL P√∫blica da Foto
                    const fotoUrl = `${PROJECT_URL}/storage/v1/object/public/evidencias/${nomeArquivo}`;
                    
                    status.innerText = "üíæ Salvando registro no banco...";

                    // 5. Salvar Dados no Banco
                    const { error: erroBanco } = await meuSupabase.from('checklists').insert({
                        placa: placa,
                        motorista: motorista,
                        pneu_ok: pneuOk,
                        foto_url: fotoUrl,
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    });

                    if (erroBanco) throw erroBanco;

                    // 6. Sucesso
                    alert("‚úÖ SUCESSO! \nRegistro enviado e salvo na nuvem.");
                    window.location.reload();

                } catch (erro) {
                    alert("‚ùå ERRO: " + erro.message);
                    status.innerText = "Falha no envio. Tente novamente.";
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = '<span>üìç ENVIAR REGISTRO</span>';
                }
            }, (erroGPS) => {
                let msg = "Erro desconhecido no GPS.";
                if (erroGPS.code === 1) msg = "Permiss√£o de GPS negada. Ative nas configura√ß√µes do site.";
                if (erroGPS.code === 2) msg = "Sinal GPS indispon√≠vel. V√° para local aberto.";
                if (erroGPS.code === 3) msg = "GPS demorou muito para responder.";
                
                alert("‚ö†Ô∏è " + msg);
                status.innerText = "Erro: Sem localiza√ß√£o";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = '<span>üìç ENVIAR REGISTRO</span>';
            }, opcoesGPS);
        }
    </script>
</body>
</html>
